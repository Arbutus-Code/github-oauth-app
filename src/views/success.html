<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authentication Success</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
        color: #333;
        text-align: center;
      }
      .container {
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Success! (Debug Mode)</h1>
      <p id="status-message">Attempting to send authentication details...</p>
      <div style="text-align: left; margin-top: 20px;">
        <p><strong>Token:</strong> <code id="token-display"></code></p>
        <p><strong>Target Origin:</strong> <code id="origin-display"></code></p>
        <p><strong>Full Message:</strong> <code id="message-display"></code></p>
      </div>
    </div>
    <script>
      (function () {
        if (window.opener) {
          window.opener.postMessage("authorizing:github", "*");
        }

        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");
        const origin = params.get("origin") || "*";
        const provider = "github";

        // Display details on the page
        document.getElementById("token-display").textContent = token || "Not found";
        document.getElementById("origin-display").textContent = origin;
        document.getElementById("status-message").textContent = "Processing authentication details...";

        if (token && origin !== "*") {
          if (window.opener) {
            const jsonData = JSON.stringify({ token: token, provider: provider });
            const message = `authorization:${provider}:success:${jsonData}`;
            
            document.getElementById("message-display").textContent = message;
            document.getElementById("status-message").textContent = "Attempting to send authentication details to opener...";

            // Explicit console logging in the popup
            console.log("[OAuth Success Page] Token:", token);
            console.log("[OAuth Success Page] Target Origin:", origin);
            console.log("[OAuth Success Page] Provider:", provider);
            console.log("[OAuth Success Page] Full message to post:", message);

            try {
              window.opener.postMessage(message, origin);
              document.getElementById("status-message").textContent = "Authentication details SENT to opener. Target origin: " + origin + ". You can manually close this window if it doesn't close automatically (auto-close is temporarily disabled for debugging).";
              console.log("[OAuth Success Page] postMessage sent successfully to origin:", origin);
              // window.close(); // Temporarily commented out for debugging
            } catch (e) {
              document.getElementById("status-message").textContent = "ERROR sending details: " + e.message;
              console.error("[OAuth Success Page] Error during postMessage:", e);
            }
          } else {
            document.getElementById("status-message").textContent = "ERROR: window.opener is not available. Cannot send details.";
            console.error("[OAuth Success Page] window.opener is not available.");
          }
        } else {
          console.error("No opener window found. Cannot post message.");
          document.getElementById('status-message').textContent = 'Error: No opener window found. Cannot post message.';
          document.getElementById('token-display').textContent = 'N/A';
          document.getElementById('origin-display').textContent = 'N/A';
          document.getElementById('message-display').textContent = 'N/A';
        }
      })();
    </script>
  </body>
</html>
